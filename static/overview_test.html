<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overview测试 - 小文件</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #0a1628;
        }
        #canvas {
            width: 100vw;
            height: 100vh;
            display: block;
        }
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #00ff00;
            font-family: monospace;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 5px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="info">测试加载CenterLine.glb (186KB)...<br></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/OrbitControls.js"></script>

    <script>
        const info = document.getElementById('info');

        function log(message) {
            console.log(message);
            info.innerHTML += message + '<br>';
            info.scrollTop = info.scrollHeight;
        }

        log('开始初始化Three.js...');

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a1628);

        const canvas = document.getElementById('canvas');
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100000);
        camera.position.set(0, 100, 200);

        const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(100, 200, 100);
        scene.add(directionalLight);

        const gridHelper = new THREE.GridHelper(500, 20);
        scene.add(gridHelper);

        log('✓ 场景初始化完成');

        // 测试三个路径
        const testPaths = [
            { name: '相对路径', path: 'glb/CenterLine.glb' },
            { name: 'Flask路由', path: '/static/glb/CenterLine.glb' },
            { name: '完整静态路径', path: './glb/CenterLine.glb' }
        ];

        let currentIndex = 0;

        function tryLoad() {
            if (currentIndex >= testPaths.length) {
                log('❌ 所有路径都失败了');
                return;
            }

            const test = testPaths[currentIndex];
            log(`<br>尝试 ${currentIndex + 1}/${testPaths.length}: ${test.name}`);
            log(`路径: ${test.path}`);

            const loader = new THREE.GLTFLoader();
            const startTime = Date.now();

            loader.load(
                test.path,
                function(gltf) {
                    const loadTime = ((Date.now() - startTime) / 1000).toFixed(2);
                    log(`<span style="color: #00ff00;">✓✓✓ 成功！耗时 ${loadTime}秒</span>`);

                    const model = gltf.scene;
                    scene.add(model);

                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());

                    log(`模型中心: (${center.x.toFixed(2)}, ${center.y.toFixed(2)}, ${center.z.toFixed(2)})`);
                    log(`模型尺寸: (${size.x.toFixed(2)}, ${size.y.toFixed(2)}, ${size.z.toFixed(2)})`);

                    model.position.sub(center);

                    const maxDim = Math.max(size.x, size.y, size.z);
                    camera.position.set(maxDim, maxDim * 0.8, maxDim * 1.5);
                    camera.lookAt(0, 0, 0);
                    controls.target.set(0, 0, 0);
                    controls.update();

                    log('<br>现在尝试加载大文件 9-10Ground.glb (354MB)...');
                    setTimeout(() => loadBigFile(test.path), 2000);
                },
                function(xhr) {
                    if (xhr.lengthComputable) {
                        const percent = (xhr.loaded / xhr.total * 100).toFixed(1);
                        log(`加载进度: ${percent}%`);
                    }
                },
                function(error) {
                    log(`<span style="color: #ff4444;">✗ 失败: ${error.message || error}</span>`);
                    currentIndex++;
                    setTimeout(tryLoad, 1000);
                }
            );
        }

        function loadBigFile(basePath) {
            const bigPath = basePath.replace('CenterLine.glb', '9-10Ground.glb');
            log(`<br>尝试加载大文件: ${bigPath}`);

            const loader = new THREE.GLTFLoader();
            const startTime = Date.now();

            loader.load(
                bigPath,
                function(gltf) {
                    const loadTime = ((Date.now() - startTime) / 1000).toFixed(2);
                    log(`<span style="color: #00ff00;">✓✓✓ 大文件加载成功！耗时 ${loadTime}秒</span>`);
                    log('所有问题已解决！');
                },
                function(xhr) {
                    if (xhr.lengthComputable) {
                        const percent = (xhr.loaded / xhr.total * 100).toFixed(1);
                        const loadedMB = (xhr.loaded / 1024 / 1024).toFixed(1);
                        const totalMB = (xhr.total / 1024 / 1024).toFixed(1);
                        log(`大文件进度: ${percent}% (${loadedMB}/${totalMB} MB)`);
                    } else {
                        const loadedMB = (xhr.loaded / 1024 / 1024).toFixed(1);
                        log(`已下载: ${loadedMB} MB`);
                    }
                },
                function(error) {
                    log(`<span style="color: #ff4444;">✗ 大文件加载失败: ${error.message || error}</span>`);
                    log(`错误详情: ${JSON.stringify(error)}`);
                }
            );
        }

        tryLoad();

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', function() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
